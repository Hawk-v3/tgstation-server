<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>tgstation-server: src/Tgstation.Server.Host.Service/Program.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="tgs.ico"/></td>
  <td id="projectalign">
   <div id="projectname">tgstation-server<span id="projectnumber">&#160;5.12.6</span>
   </div>
   <div id="projectbrief">The /tg/station 13 server suite</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_a01d946a2e1b048dc542232ffcdcf572.html">Tgstation.Server.Host.Service</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">Program.cs</div></div>
</div><!--header-->
<div class="contents">
<a href="_tgstation_8_server_8_host_8_service_2_program_8cs.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="keyword">using </span>System;</div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="keyword">using </span>System.Collections.Specialized;</div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="keyword">using </span>System.Configuration.Install;</div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="keyword">using </span>System.Diagnostics;</div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="keyword">using </span>System.Globalization;</div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="keyword">using </span>System.Linq;</div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="keyword">using </span>System.Reflection;</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="keyword">using </span>System.Security.Principal;</div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="keyword">using </span>System.ServiceProcess;</div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="keyword">using </span>System.Threading;</div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="keyword">using </span>System.Threading.Tasks;</div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="keyword">using </span>System.Windows.Forms;</div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span> </div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="keyword">using </span>McMaster.Extensions.CommandLineUtils;</div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span> </div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="keyword">using </span>Microsoft.Extensions.Logging;</div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span> </div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="keyword">using </span><a class="code hl_namespace" href="namespace_tgstation_1_1_server_1_1_host_1_1_watchdog.html">Tgstation.Server.Host.Watchdog</a>;</div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span> </div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno"><a class="line" href="namespace_tgstation_1_1_server_1_1_host_1_1_service.html">   20</a></span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespace_tgstation_1_1_server_1_1_host_1_1_service.html">Tgstation.Server.Host.Service</a></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>{</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html">   25</a></span>    sealed <span class="keyword">class </span><a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html">Program</a></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>    {</div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="preprocessor">#pragma warning disable SA1401 </span><span class="comment">// Fields should be private</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>        <span class="keyword">internal</span> <span class="keyword">static</span> <a class="code hl_interface" href="interface_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_i_watchdog_factory.html">IWatchdogFactory</a> <a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory.html">WatchdogFactory</a> = <span class="keyword">new</span> <a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory.html">WatchdogFactory</a>();</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span><span class="preprocessor">#pragma warning restore SA1401 </span><span class="comment">// Fields should be private</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span> </div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>        [Option(ShortName = <span class="stringliteral">&quot;u&quot;</span>)]</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a6868da29a3857b56bba33e5d7c623b68">   38</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a6868da29a3857b56bba33e5d7c623b68">Uninstall</a> { <span class="keyword">get</span>; }</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span> </div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>        [Option(ShortName = <span class="stringliteral">&quot;i&quot;</span>)]</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae3be244b24cbb3c9ba859f55e53715e6">   44</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae3be244b24cbb3c9ba859f55e53715e6">Install</a> { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span> </div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>        [Option(ShortName = <span class="stringliteral">&quot;c&quot;</span>)]</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">   50</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">Configure</a> { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span> </div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>        [Option(ShortName = <span class="stringliteral">&quot;t&quot;</span>)]</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a5d7201b8cfa09c341ec68d81297aabad">   56</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a5d7201b8cfa09c341ec68d81297aabad">Trace</a> { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span> </div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>        [Option(ShortName = <span class="stringliteral">&quot;d&quot;</span>)]</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a938d576ceba93bf3cb1a32ae1dcccc52">   62</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a938d576ceba93bf3cb1a32ae1dcccc52">Debug</a> { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span> </div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a5c942ce276ce92ca31ecbe9c88f2e982">   68</a></span>        <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a5c942ce276ce92ca31ecbe9c88f2e982">IsAdministrator</a>()</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>        {</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>            var user = WindowsIdentity.GetCurrent();</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>            var principal = <span class="keyword">new</span> WindowsPrincipal(user);</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>            <span class="keywordflow">return</span> principal.IsInRole(WindowsBuiltInRole.Administrator);</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>        }</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span> </div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a0b94eaf8077d6c2830834b9fc8dd2205">   80</a></span>        <span class="keyword">static</span> Task&lt;int&gt; <a class="code hl_function" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a0b94eaf8077d6c2830834b9fc8dd2205">Main</a>(<span class="keywordtype">string</span>[] args) =&gt; CommandLineApplication.ExecuteAsync&lt;<a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html">Program</a>&gt;(args);</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span> </div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae25637d5f1e273ad93fe3ea34ba6a6c2">   85</a></span>        <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae25637d5f1e273ad93fe3ea34ba6a6c2">RunServiceInstall</a>()</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>        {</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>            <span class="comment">// First check if the service already exists</span></div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>            <span class="keywordflow">if</span> (Environment.UserInteractive)</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>                <span class="keywordflow">foreach</span> (ServiceController sc <span class="keywordflow">in</span> ServiceController.GetServices())</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>                    <span class="keywordflow">if</span> (sc.ServiceName == <span class="stringliteral">&quot;tgstation-server&quot;</span> || sc.ServiceName == <span class="stringliteral">&quot;tgstation-server-4&quot;</span>)</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>                    {</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>                        DialogResult result = MessageBox.Show($<span class="stringliteral">&quot;You already have another TGS service installed ({sc.ServiceName}). Would you like to uninstall it now? Pressing \&quot;No\&quot; will cancel this install.&quot;</span>, <span class="stringliteral">&quot;TGS Service&quot;</span>, MessageBoxButtons.YesNo);</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>                        <span class="keywordflow">if</span> (result != DialogResult.Yes)</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>                            <span class="keywordflow">return</span>; <span class="comment">// is this needed after exit?</span></div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span> </div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>                        <span class="comment">// Stop it first to give it some cleanup time</span></div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>                        <span class="keywordflow">if</span> (sc.Status == ServiceControllerStatus.Running)</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>                        {</div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>                            sc.Stop();</div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>                            sc.WaitForStatus(ServiceControllerStatus.Stopped);</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>                        }</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span> </div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>                        <span class="comment">// And remove it</span></div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>                        <span class="keyword">using </span>var serviceInstaller = <span class="keyword">new</span> ServiceInstaller();</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>                        serviceInstaller.Context = <span class="keyword">new</span> InstallContext($<span class="stringliteral">&quot;old-{sc.ServiceName}-uninstall.log&quot;</span>, <span class="keyword">null</span>);</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>                        serviceInstaller.ServiceName = sc.ServiceName;</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>                        serviceInstaller.Uninstall(<span class="keyword">null</span>);</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>                    }</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span> </div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>            <span class="keyword">using </span>var processInstaller = <span class="keyword">new</span> ServiceProcessInstaller();</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>            <span class="keyword">using </span>var installer = <span class="keyword">new</span> ServiceInstaller();</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>            processInstaller.Account = ServiceAccount.LocalSystem;</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span> </div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>            installer.Context = <span class="keyword">new</span> InstallContext(<span class="stringliteral">&quot;tgs-install.log&quot;</span>, <span class="keyword">new</span> <span class="keywordtype">string</span>[] { String.Format(CultureInfo.InvariantCulture, <span class="stringliteral">&quot;/assemblypath={0}&quot;</span>, Assembly.GetEntryAssembly().Location) });</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>            installer.Description = <span class="stringliteral">&quot;/tg/station 13 server running as a windows service&quot;</span>;</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>            installer.DisplayName = <span class="stringliteral">&quot;/tg/station server&quot;</span>;</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>            installer.StartType = ServiceStartMode.Automatic;</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>            installer.ServicesDependedOn = <span class="keyword">new</span> <span class="keywordtype">string</span>[] { <span class="stringliteral">&quot;Tcpip&quot;</span>, <span class="stringliteral">&quot;Dhcp&quot;</span>, <span class="stringliteral">&quot;Dnscache&quot;</span> };</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>            installer.ServiceName = <a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service.html">ServerService</a>.<a class="code hl_variable" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service.html#a82a1c35bb13819cd1003592351251fc1">Name</a>;</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>            installer.Parent = processInstaller;</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span> </div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>            var state = <span class="keyword">new</span> ListDictionary();</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>            installer.Install(state);</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>        }</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span> </div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno"><a class="line" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a86d24d735c64eb7c67a935b809927dd4">  130</a></span>        <span class="keyword">public</span> async Task <a class="code hl_function" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a86d24d735c64eb7c67a935b809927dd4">OnExecuteAsync</a>()</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>        {</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>            <span class="keywordflow">if</span> (Environment.UserInteractive)</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>            {</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>                <span class="keywordflow">if</span> (!<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae3be244b24cbb3c9ba859f55e53715e6">Install</a> &amp;&amp; !<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a6868da29a3857b56bba33e5d7c623b68">Uninstall</a> &amp;&amp; !<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">Configure</a>)</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>                {</div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>                    var result = MessageBox.Show(<span class="stringliteral">&quot;You are running the TGS windows service executable directly. It should only be run by the service control manager. Would you like to install and configure the service in this location?&quot;</span>, <span class="stringliteral">&quot;TGS Service&quot;</span>, MessageBoxButtons.YesNo);</div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>                    <span class="keywordflow">if</span> (result != DialogResult.Yes)</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>                        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>                    <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae3be244b24cbb3c9ba859f55e53715e6">Install</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>                    <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">Configure</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>                }</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span> </div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>                <span class="keywordflow">if</span> (!<a class="code hl_function" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a5c942ce276ce92ca31ecbe9c88f2e982">IsAdministrator</a>())</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>                {</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>                    <span class="comment">// try to restart as admin</span></div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>                    <span class="comment">// its windows, first arg is .exe name guaranteed</span></div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>                    var exe = Environment.GetCommandLineArgs().First();</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>                    var startInfo = <span class="keyword">new</span> ProcessStartInfo</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>                    {</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>                        UseShellExecute = <span class="keyword">true</span>,</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>                        Verb = <span class="stringliteral">&quot;runas&quot;</span>,</div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>                        Arguments = String.Format(CultureInfo.InvariantCulture, <span class="stringliteral">&quot;{0} {1}&quot;</span>, <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae3be244b24cbb3c9ba859f55e53715e6">Install</a> ? <span class="stringliteral">&quot;-i&quot;</span> : <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a6868da29a3857b56bba33e5d7c623b68">Uninstall</a> ? <span class="stringliteral">&quot;-u&quot;</span> : String.Empty, <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">Configure</a> ? <span class="stringliteral">&quot;-c&quot;</span> : String.Empty),</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>                        FileName = exe,</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>                        WorkingDirectory = Environment.CurrentDirectory,</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>                    };</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>                    <span class="keyword">using</span> (Process.Start(startInfo))</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>                        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>                }</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>            }</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span> </div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>            <span class="keywordflow">if</span> (<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae3be244b24cbb3c9ba859f55e53715e6">Install</a>)</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>            {</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>                <span class="keywordflow">if</span> (<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a6868da29a3857b56bba33e5d7c623b68">Uninstall</a>)</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>                    <span class="keywordflow">return</span>; <span class="comment">// oh no, it&#39;s retarded...</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span> </div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>                <a class="code hl_function" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae25637d5f1e273ad93fe3ea34ba6a6c2">RunServiceInstall</a>();</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span> </div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>                <span class="keywordflow">if</span> (<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">Configure</a>)</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>                {</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>                    Console.WriteLine(<span class="stringliteral">&quot;For this first run we&#39;ll launch the console runner so you may use the setup wizard.&quot;</span>);</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>                    Console.WriteLine(<span class="stringliteral">&quot;If it starts successfully, feel free to close it and then start the service from the Windows control panel.&quot;</span>);</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>                }</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>            }</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a6868da29a3857b56bba33e5d7c623b68">Uninstall</a>)</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>                <span class="keyword">using</span> (var installer = <span class="keyword">new</span> ServiceInstaller())</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>                {</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>                    installer.Context = <span class="keyword">new</span> InstallContext(<span class="stringliteral">&quot;tgs-uninstall.log&quot;</span>, <span class="keyword">null</span>);</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>                    installer.ServiceName = <a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service.html">ServerService</a>.<a class="code hl_variable" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service.html#a82a1c35bb13819cd1003592351251fc1">Name</a>;</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>                    installer.Uninstall(<span class="keyword">null</span>);</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>                }</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">Configure</a>)</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>            {</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>                <span class="keyword">using </span>var service = <span class="keyword">new</span> <a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service.html">ServerService</a>(<a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory.html">WatchdogFactory</a>, <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a5d7201b8cfa09c341ec68d81297aabad">Trace</a> ? LogLevel.Trace : <a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a938d576ceba93bf3cb1a32ae1dcccc52">Debug</a> ? LogLevel.Debug : LogLevel.Information);</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>                <a class="code hl_class" href="class_service_base.html">ServiceBase</a>.Run(service);</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>            }</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span> </div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>            <span class="keywordflow">if</span> (<a class="code hl_property" href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">Configure</a>)</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>            {</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>                <span class="keyword">using </span>var loggerFactory = LoggerFactory.Create(builder =&gt; builder.AddConsole());</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>                await <a class="code hl_class" href="class_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory.html">WatchdogFactory</a>.<a class="code hl_function" href="class_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory.html#ae25446ee2a7bb19d9208695d18621914">CreateWatchdog</a>(loggerFactory)</div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>                    .<a class="code hl_function" href="interface_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_i_watchdog.html#abe13ec45a7d7ba7db422ea661156b697">RunAsync</a>(<span class="keyword">true</span>, Array.Empty&lt;<span class="keywordtype">string</span>&gt;(), CancellationToken.None); <span class="comment">// DCT: None available</span></div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>            }</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>        }</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>    }</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>}</div>
<div class="ttc" id="aclass_service_base_html"><div class="ttname"><a href="class_service_base.html">ServiceBase</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html">Tgstation.Server.Host.Service.Program</a></div><div class="ttdoc">Contains the entrypoint for the application.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00025">Program.cs:26</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_a0b94eaf8077d6c2830834b9fc8dd2205"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a0b94eaf8077d6c2830834b9fc8dd2205">Tgstation.Server.Host.Service.Program.Main</a></div><div class="ttdeci">static Task&lt; int &gt; Main(string[] args)</div><div class="ttdoc">Entrypoint for the application.</div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_a5c942ce276ce92ca31ecbe9c88f2e982"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a5c942ce276ce92ca31ecbe9c88f2e982">Tgstation.Server.Host.Service.Program.IsAdministrator</a></div><div class="ttdeci">static bool IsAdministrator()</div><div class="ttdoc">Check if the running user is a system administrator.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00068">Program.cs:68</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_a5d7201b8cfa09c341ec68d81297aabad"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a5d7201b8cfa09c341ec68d81297aabad">Tgstation.Server.Host.Service.Program.Trace</a></div><div class="ttdeci">bool Trace</div><div class="ttdoc">The –trace or -t option. Enables trace logs.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00056">Program.cs:56</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_a6868da29a3857b56bba33e5d7c623b68"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a6868da29a3857b56bba33e5d7c623b68">Tgstation.Server.Host.Service.Program.Uninstall</a></div><div class="ttdeci">bool Uninstall</div><div class="ttdoc">The –uninstall or -u option.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00038">Program.cs:38</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_a86d24d735c64eb7c67a935b809927dd4"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a86d24d735c64eb7c67a935b809927dd4">Tgstation.Server.Host.Service.Program.OnExecuteAsync</a></div><div class="ttdeci">async Task OnExecuteAsync()</div><div class="ttdoc">Command line handler, always runs.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00130">Program.cs:130</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_a938d576ceba93bf3cb1a32ae1dcccc52"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#a938d576ceba93bf3cb1a32ae1dcccc52">Tgstation.Server.Host.Service.Program.Debug</a></div><div class="ttdeci">bool Debug</div><div class="ttdoc">The –debug or -d option. Enables debug logs.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00062">Program.cs:62</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_aaba3eb445c2c2c0f8a11d150096b7457"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#aaba3eb445c2c2c0f8a11d150096b7457">Tgstation.Server.Host.Service.Program.Configure</a></div><div class="ttdeci">bool Configure</div><div class="ttdoc">The –configure or -c option.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00050">Program.cs:50</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_ae25637d5f1e273ad93fe3ea34ba6a6c2"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae25637d5f1e273ad93fe3ea34ba6a6c2">Tgstation.Server.Host.Service.Program.RunServiceInstall</a></div><div class="ttdeci">static void RunServiceInstall()</div><div class="ttdoc">Attempt to install the TGS Service.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00085">Program.cs:85</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_program_html_ae3be244b24cbb3c9ba859f55e53715e6"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_program.html#ae3be244b24cbb3c9ba859f55e53715e6">Tgstation.Server.Host.Service.Program.Install</a></div><div class="ttdeci">bool Install</div><div class="ttdoc">The –install or -i option.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00044">Program.cs:44</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service_html"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service.html">Tgstation.Server.Host.Service.ServerService</a></div><div class="ttdoc">Represents a IWatchdog as a ServiceBase.</div><div class="ttdef"><b>Definition:</b> <a href="_server_service_8cs_source.html#l00018">ServerService.cs:19</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service_html_a82a1c35bb13819cd1003592351251fc1"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_service_1_1_server_service.html#a82a1c35bb13819cd1003592351251fc1">Tgstation.Server.Host.Service.ServerService.Name</a></div><div class="ttdeci">const string Name</div><div class="ttdoc">The canonical windows service name.</div><div class="ttdef"><b>Definition:</b> <a href="_server_service_8cs_source.html#l00023">ServerService.cs:23</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory_html"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory.html">Tgstation.Server.Host.Watchdog.WatchdogFactory</a></div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_watchdog_2_watchdog_factory_8cs_source.html#l00008">WatchdogFactory.cs:9</a></div></div>
<div class="ttc" id="aclass_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory_html_ae25446ee2a7bb19d9208695d18621914"><div class="ttname"><a href="class_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_watchdog_factory.html#ae25446ee2a7bb19d9208695d18621914">Tgstation.Server.Host.Watchdog.WatchdogFactory.CreateWatchdog</a></div><div class="ttdeci">IWatchdog CreateWatchdog(ILoggerFactory loggerFactory)</div><div class="ttdoc">Create a IWatchdog. A new IWatchdog.</div></div>
<div class="ttc" id="ainterface_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_i_watchdog_factory_html"><div class="ttname"><a href="interface_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_i_watchdog_factory.html">Tgstation.Server.Host.Watchdog.IWatchdogFactory</a></div><div class="ttdoc">Factory for creating IWatchdogs.</div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_watchdog_2_i_watchdog_factory_8cs_source.html#l00008">IWatchdogFactory.cs:9</a></div></div>
<div class="ttc" id="ainterface_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_i_watchdog_html_abe13ec45a7d7ba7db422ea661156b697"><div class="ttname"><a href="interface_tgstation_1_1_server_1_1_host_1_1_watchdog_1_1_i_watchdog.html#abe13ec45a7d7ba7db422ea661156b697">Tgstation.Server.Host.Watchdog.IWatchdog.RunAsync</a></div><div class="ttdeci">Task RunAsync(bool runConfigure, string[] args, CancellationToken cancellationToken)</div><div class="ttdoc">Run the IWatchdog.</div></div>
<div class="ttc" id="anamespace_tgstation_1_1_server_1_1_host_1_1_service_html"><div class="ttname"><a href="namespace_tgstation_1_1_server_1_1_host_1_1_service.html">Tgstation.Server.Host.Service</a></div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_service_2_program_8cs_source.html#l00020">Program.cs:21</a></div></div>
<div class="ttc" id="anamespace_tgstation_1_1_server_1_1_host_1_1_watchdog_html"><div class="ttname"><a href="namespace_tgstation_1_1_server_1_1_host_1_1_watchdog.html">Tgstation.Server.Host.Watchdog</a></div><div class="ttdef"><b>Definition:</b> <a href="_tgstation_8_server_8_host_8_watchdog_2_i_watchdog_8cs_source.html#l00004">IWatchdog.cs:5</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
